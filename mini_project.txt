Получена задача по восстановлению работоспособности Linux-сервера. Известно, что на сервере запущен web-сервер, работает веб-приложение (MediaWiki) и настроены резервные копии.По неизвестной причине сервис перестал работать.

Дана ссылка на сайт https://3.73.79.83/ при открытии которого появляется ошибка $wgServer must be set in LocalSettings.php.
See https://www.mediawiki.org/wiki/Manual:$wgServer

ssh -i ich.pem ec2-user@3.73.79.83/ - подключаемся к серверу (-i  путь к ключу)

ls -al - список файлов, включая скрытые

 - перезапускаем сервис
sudo service httpd status - проверяем перезапустился ли сервис
ошибка осталась

cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php- пробуем скопировать бэкап LocalSettings (5).php туда где он должен быть, т.е. в /var/www/html/mediawiki/LocalSettings.php

получаем ошибку No space left on device - не хватает дискового пространства

df -h - проверяем дисковое пространство (-h отображает данные в удобном для чтения формате)

sudo find / -type f -size +100M -exec du -h {} \;  - ищем крупные файлы
    sudo        -запуск от имени администратора
    find /	- искать начиная с корня /
   -type f	- только файлы, игнорируя папки
   -size +100M	- размер файла больше 100 мегабайт
   -exec du -h {} \;	для каждого найденного файла ({}) выполнить команду du -h (показывает размер файла в читабельном виде)

находим файл  /var/log/httpd/access_log-20260202 , который занимает много дискового пространства

необходимо освободить место

sudo rm -rf /var/log/httpd/access_log-20260202 - удаляем файл логов
    rm                                 - удаление файла (или папки)
    -rf                                - рекурсивно без подтверждения
    /var/log/httpd/access_log-20260202 - путь к файлу

Снова пытаемся скопировать файл: cp LocalSettings\ \(5\).php /var/www/html/mediawiki/LocalSettings.php

копирование прошло успешно

перезапускаем сервис - sudo service httpd restart
сайт по прежнему не доступен
IP-адрес сервера изменился
В файле LocalSettings.php указываем правильный IP-адрес  $wgServer = "https://3.73.79.83/"
перезапускаем сервис - sudo systemctl restart httpd (поменяли местами аргументы, что делать и потом с каким сервисотмСай)
                       sudo systemctl status httpd
сайт заработал

теперь ищем проичину возникновения проблемы
sudo ls -lah /var/log/httpd
    h - отображенте в удобном виде
 
замечаем, что Файл access_log увеличивается в размере
sudo crontab -l  смотрим текущие настройки - архив архивирует сам себя каждую минуту
sudo crontab -e изменяем текущие настройки, открываем редактор и останавливаем #)

sudo su - переходим под root
удаляем старые gzip-файлы: rm -rf /var/log/httpd/*.gzip
ls -lah /var/log/httpd - проверяем
старые архивы удаленя

Создаём скрипт для архивации логов - backup_log.sh

#!/bin/bash
#
LOG_DIR="/var/log/httpd"                            - что будем архивировать
BACKUP_DIR="/home/ec2-user/backup_http"             - директория где будет храниться бэкап
MAX_BACKUP="+3"                                     - указываем временя хранения

DATE=$(date '+%Y%m%d-%T')                           - текущая дата
ARCHIVE="$BACKUP_DIR/backup_httpd_log-$DATE.tar.gz" -  имя архива
mkdir -p "$BACKUP_DIR"                              - создаем директорию( позволяет создавать папки без появления сообщений об ошибках, если часть пути уже существует)

tar -czf "$ARCHIVE" «$LOG_DIR/"                     - архивируем лог файлы
                                                    -с создаем
                                                    -z сжимаем
                                                    -f файл

service httpd stop                                   - останавливаем сервис

rm -rf "$LOG_DIR"/*                                  - удаляем все файлы

service httpd start                                  - перезапускаем сервис

find "$BACKUP_DIR" -type f -name "Backup_httpd_log*" -mtime "$MAX_BACKUP" -exec rm -rf {} \; - ищем файлы(-type f) с указанным началом имени(-name "Backup_httpd_log*") и которые были созданы указанное количество дней назад( -mtime "$MAX_BACKUP"). Удаляем каждый такой файл(-exec rm -rf {}). завершение команды -exec (\;)

chmod +x backup_log.sh                               - делаем файл исполняемым

crontab -e
5 3 * * * /home/ec2-user/backup_log.sh               - добавляем новое задания(Ежедневно в 03:05 будет создаваться архив логов, копии старше 3х дней автоматически удаляются)


Причины инцидента

причиной инцидента стало отсутствие свободного места на диске в связи с тем, что бэкап системы был настроен не правильно

Предпринятые шаги для восстановления сервиса и устранения проблемы и полученные результаты

очищено дисковое пространство и удалены лишние файлы
восстановлен конфигурационный файл MediaWiki
исправлены ошибки в заданиях cron
настроена автоматическая архивация и очистка логов

Формулирование рекомендаций и предложений по улучшению процессов

Настроить мониторинг свободного места на диске.
Использовать статический IP-адрес, чтобы сервер корректно работал после перезагрузок.
При необходимости приобрести постоянный домен и статический IP-адрес.
Настроить регулярное архивирование логов.
Периодически контролировать использование дискового пространства.
Проверять корректность заданий в crontab.
Хранить резервные копии конфигурационных файлов в безопасных местах.